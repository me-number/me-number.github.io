name: Project Build and Deployment with Database Setup to Cloudflare Workers

# This workflow runs on pushes to main and develop branches,
# and on pull requests to main branch
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Environment variables for Cloudflare deployment
env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

jobs:
  # Build and test job to verify the code before deployment
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      # Using Node.js 18 which is current stable version
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Cache node modules for faster subsequent builds
          cache: 'npm'

      # Step 3: Install dependencies using npm ci
      # npm ci ensures clean installation from package-lock.json
      - name: Install dependencies
        run: npm ci
        # Error handling: If dependencies fail to install, the workflow stops

      # Step 4: Execute build script
      # Builds the frontend project and places output in public directory
      - name: Execute build script
        run: npm run build
        # Error handling: If build fails, the workflow stops
        # This creates the public directory with built assets

      # Step 5: Run any tests to ensure code quality
      - name: Run tests
        run: npm test || echo "Tests skipped or no test script found"
        # Continue even if tests fail, but log the issue

  # Database setup job to initialize the database
  database-setup:
    # Only run database setup when deploying from main branch
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Setup Wrangler for Cloudflare operations
      - name: Setup Cloudflare Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: --version

      # Step 5: Execute database schema
      # This command runs the SQL schema file against the cloud-pan D1 database
      - name: Execute database schema
        run: npx wrangler d1 execute cloud-pan --file=./schema.sql
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        # Error handling: If schema execution fails, the workflow stops

  # Deploy job that runs after successful build
  deploy:
    # Only run this job after build-and-test completes successfully
    needs: [build-and-test, database-setup]
    runs-on: ubuntu-latest
    # Only deploy from main branch, not from PRs or other branches
    if: github.ref == 'refs/heads/main'
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Execute build script to ensure public directory exists
      - name: Execute build script
        run: npm run build
        # Ensure the public directory has the latest build artifacts

      # Step 5: Setup Wrangler for Cloudflare deployment
      - name: Setup Cloudflare Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: --version

      # Step 6: Deploy backend and frontend to Cloudflare Workers
      - name: Deploy backend and frontend to Cloudflare Workers
        run: npm run deploy
        # Pass necessary environment variables for deployment
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        # Error handling: If deployment fails, the workflow will show an error

  # Final notification job that runs regardless of success or failure
  notify:
    # Run after all other jobs have completed
    needs: [build-and-test, database-setup, deploy]
    runs-on: ubuntu-latest
    # Always run this job to provide final status information
    if: always()
    
    steps:
      # Log the results of the previous jobs
      - name: Log workflow completion status
        run: |
          BUILD_TEST_STATUS="${{ needs.build-and-test.result }}"
          DB_SETUP_STATUS="${{ needs.database-setup.result }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"
          
          echo "Build and Test Job Status: $BUILD_TEST_STATUS"
          echo "Database Setup Job Status: $DB_SETUP_STATUS"
          echo "Deploy Job Status: $DEPLOY_STATUS"
          
          # Provide summary based on job results
          if [[ "$BUILD_TEST_STATUS" == "success" ]]; then
            echo "Build and test phase completed successfully"
          else
            echo "Build and test phase had issues"
          fi
          
          if [[ "$DB_SETUP_STATUS" == "success" ]]; then
            echo "Database setup completed successfully"
          elif [[ "$DB_SETUP_STATUS" == "skipped" ]]; then
            echo "Database setup was skipped"
          else
            echo "Database setup had issues"
          fi
          
          if [[ "$DEPLOY_STATUS" == "success" ]]; then
            echo "Deployment completed successfully"
          elif [[ "$DEPLOY_STATUS" == "skipped" ]]; then
            echo "Deployment was skipped (likely due to branch condition)"
          else
            echo "Deployment had issues"
          fi
